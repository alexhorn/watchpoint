"""
This provides a way to check if a SMB server allows
anonymous login.
"""

import uuid
from smbprotocol.connection import Connection, Dialects
from smbprotocol.session import Session
from smbprotocol.exceptions import SMBAuthenticationError

TIMEOUT = 5

class SMBCredentialChecker:
    def __init__(self):
        pass

    def check(self, ip_addr, port=445):
        """Checks whether a SMB server allows login without credentials"""

        try:
            # connect and attempt authentication
            connection = Connection(uuid.uuid4(), ip_addr, port, require_signing=False)
            connection.connect(Dialects.SMB_2_0_2, timeout=TIMEOUT)
            try:
                session = Session(connection, "", "", require_encryption=False) # dont require encryption or signing to support o2 HomeBox

                try:
                    session.connect()
                except SMBAuthenticationError:
                    return False

                return ("", "")
            finally:
                connection.disconnect()
        except Exception as e:
            print("SMB connection failed")
            print(e)

            return False
